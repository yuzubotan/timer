<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <style>
        body {
            background-color: #bcffff;
            max-width: 900px;
            
        }

        header {
            width: 96%;
        }

        .header {
            font-weight: bold;
            background-color: white;
            border-radius: 10px;
            width: 93px;
            height: 46px;
            line-height: 46px;
            display: inline-block;
            font-size: 16px;
            text-align: center;
            
        }
        #switch {
            float:right;
        }

        #wait_time {
            text-align: center;
            font-size: 96px;
        }

        .grid-container {
            display: grid;
            grid-template-rows: 1fr 1fr ;
            grid-template-columns: 1fr 1fr;
            height: 159px;
            gap: 30px;
            margin-bottom: 30px;
            
        }

        .grid-item {
            background-color: white;
            box-shadow: 0 4px 4px gray;
            border: 1px solid;
        }

        .grid-item:nth-child(1) {
            
            grid-row: 1 / 2;
        }

       input {
        display: inline-block;
        padding: 8px;
       }


       .grid-1 {
        width: 180px;
        text-align: center;
        display: inline-block;
        line-height: 159px;
        font-size: 96px;
       }

       .grid-2 {
        margin-bottom: 10px;
       }

       .grid-3 {
        margin-bottom:3px;
        display: inline-block;
        width: 100px;
       }

       .grid-5 {
        display: none;
        
       }

       .time {
        display: inline-block;
       }
      
       .grid-container-2 {
        
        display: grid;
        grid-template-rows: 1fr 1fr 1fr 1fr;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 30px;
        
       }

       .grid-bt {
        background-color: white;
        width: 93px;
        height: 90px;
        text-align: center;
        line-height: 97px;
        font-size: 64px;
        box-shadow: 0 4px 4px gray;
        border: 1px solid;
       }
     
       .text-bt {
        font-size: 35px;
       }
       
       .wait_time {
        padding: 0;
       }

       #switch_bt {
        width: 60px;
        height: 25px;
        margin: 0;
       }

       .time {
        height:40px;
        width: 100px;
        font-size: 20px;
        display: inline-block;
        background-color: white;
        margin-right: 10px;
       }
       
       .addTime {
        margin-bottom: 15px;
       }

       #reset-bt {
        border: 2px solid black;
        display: inline-block;
        line-height: 40px;
        text-align: center;
       }
    </style>
</head>
<body>
    <header>
        <span id="order" class="header" onclick="location.href='/order'">æ³¨æ–‡å±¥æ­´</span>
        <span id="switch" class="header" onclick="location.href='/timeline'">switch</span>
    </header>
    <div id="wait_time">0:00:00</div>
    <button id="switch_bt">ON/OFF</button>
    <div class="grid-container">
        <div class="grid-item grid-1" id="id"></div>
            <form action="/submit" method="POST" id="form">
                <label for="time" class="label-1">æ™‚åˆ»</label><br>
                <input type="datetime-local" id="time" name="time"  class="grid-item grid-2"><br>
                <label for="number" class="label-2">æœ¬æ•°</label><br>
                <input type="text" id="number" name="number" class="grid-item grid-3">
                <label>
                    <input type="checkbox" id="is_reservation_checkbox">
                    äºˆç´„æ³¨æ–‡
                </label>
                
                <!-- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åæ˜ ã™ã‚‹éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                <input type="hidden" name="reservation" id="is_reservation" value="0">
                <input type="submit" id="submit_bt" class="grid-item grid-4">
                
            </form>
            
            <div class="grid-5" id="grid-5">
                <div class="addTime">
                    <button class="time" id="1minute--">- 1:00</button>
                    <button class="time" id="1minute++">+ 1:00</button>
                </div>
                <div class="addTime">
                    <button class="time" id="5minute--">- 5:00</button>
                    <button class="time" id="5minute++">+ 5:00</button>
                </div>
                <a href="javascript:reset()" class="time" id="reset-bt" >reset</a>
            </div>
            
        </div>
        
    <div class="grid-container-2">
        <div class="grid-bt" onclick="addNumber(10)">1</div>
        <div class="grid-bt" onclick="addNumber(20)">2</div>
        <div class="grid-bt" onclick="addNumber(30)">3</div>
        <div class="grid-bt" onclick="addNumber(40)">4</div>
        <div class="grid-bt" onclick="addNumber(50)">5</div>
        <div class="grid-bt" onclick="addNumber(60)">6</div>
        <div class="grid-bt" onclick="addNumber(70)">7</div>
        <div class="grid-bt" onclick="addNumber(80)">8</div>
        <div class="grid-bt" onclick="addNumber(90)">9</div>
        <div class="grid-bt text-bt" onclick="deleteLast();">del</div>
        <div class="grid-bt" onclick="addNumber(0)">0</div>
        <div class="grid-bt text-bt">+</div>
    </div>
<script>

let timerValue = 0;
let now = new Date();
let tv = parseInt(timerValue, 10);
let wait_minutes = new Date(now.getTime() + tv * 1000);

let timeInput = document.getElementById('time');
let isUserEditingTime = false;

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›æ¬„ã‚’æ“ä½œã—å§‹ã‚ãŸã‚‰ãƒ•ãƒ©ã‚°ON
timeInput.addEventListener('focus', function () {
    isUserEditingTime = true;
});

// æ“ä½œãŒçµ‚ã‚ã£ãŸã‚‰ãƒ•ãƒ©ã‚°OFF
timeInput.addEventListener('blur', function () {
    isUserEditingTime = false;
});


    const socket = new WebSocket('ws://localhost:3001');

    socket.onopen = function() {
        console.log("âœ… WebSocket æ¥ç¶šæˆåŠŸ");
    }

    socket.onmessage = function(event) {
        const message = JSON.parse(event.data);
        console.log("ğŸ“© ã‚¿ã‚¤ãƒãƒ¼å€¤ã‚’å—ä¿¡:", message.timerValue);
        console.log('amount:', message)
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«å¿œã˜ã¦ `is_reservation` ã®å€¤ã‚’å¤‰æ›´
        
            if (message.type === 'update' && document.getElementById("is_reservation").checked === false ) {
                console.log(wait_minutes)
                    timerValue = message.timerValue;
                    updateTimer();
                    if (!isUserEditingTime) inputWaitTime();  // å…¥åŠ›ä¸­ã§ãªã‘ã‚Œã°ä¸Šæ›¸ã
                } 

            if (message.type === 'gap') {
                console.log('gapé€ä¿¡',timerValue)
                socket.send(JSON.stringify({ action: 'increase', amount: message.amount}))
            }
            document.getElementById("is_reservation_checkbox").addEventListener("change", function () {
                document.getElementById("is_reservation").value = this.checked ? "1" : "0";
                inputWaitTime();
                }
            )}
        
        
    

    socket.onclose = function() {
    console.log("âŒ WebSocket æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
};

    const number = document.getElementById('number');
    
  
    function addNumber(num) {
        number.value += num;
    }

    function deleteLast() {
        number.value = number.value.slice(0, -1);
    }

    

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ¬¡ã®IDã‚’å–å¾—ã—ã¦è¡¨ç¤º
    window.onload = function () {
        fetch('/next-id')
            .then(response => response.json())
            .then(data => {
                const idDiv = document.getElementById('id');
                idDiv.textContent = data.nextId; // æ¬¡ã®IDã‚’è¡¨ç¤º
            })
            .catch(error => {
                console.error('æ¬¡ã®IDã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ:', error);
            });


            inputWaitTime();
           
    };

    

    function updateTimer() {
            const timerElement = document.getElementById('wait_time');
            let hours = Math.floor(timerValue / 3600);
            let minutes = Math.floor((timerValue % 3600) / 60);
            let seconds = timerValue % 60;
            
            timerElement.textContent = `${String(hours).padStart(1, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

    
    let gapSent = false;
  
    function addTelOrder() {

    let earliestReservationStart = null;
    
    <% for (let i = 0; i < data.length ; i++) { %>
        let needMinutes<%- i %> = <%= data[i].number / 10 + 5 %>; // æœ¬æ•° Ã·10 +5åˆ†
        let addTime<%- i %> = { 
            id: <%= data[i].id %>, 
            number: <%= data[i].number / 10 %>, 
            checked: <%= data[i].checked %>, 
            reservation: <%= data[i].reservation %>, 
            time: new Date('<%= data[i].time %>')
        };
        let timeToStart<%- i %> = new Date(addTime<%- i %>.time.getTime() - needMinutes<%- i %> * 60 * 1000);

        // â‘  äºˆç´„æ³¨æ–‡ã®æœ€ã‚‚æ—©ã„é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
        if (addTime<%- i %>.reservation === 1) {
            if (!earliestReservationStart || timeToStart<%- i %> < earliestReservationStart) {
                earliestReservationStart = timeToStart<%- i %>;
                
            };
        }

        // â‘¡ é€šå¸¸æ³¨æ–‡ãŒäºˆç´„å‰ã«å…¥ã‚Œã‚‰ã‚Œã‚‹ãªã‚‰é€ä¿¡ã—ã¦ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
        if (
            addTime<%- i %>.checked === 0 &&
            addTime<%- i %>.reservation === 0
        ) {
            if (!earliestReservationStart || wait_minutes < earliestReservationStart) {
                // âœ… äºˆç´„ã®å‰ã«å…¥ã‚Œã‚‰ã‚Œã‚‹
                
                socket.send(JSON.stringify({ action: 'increase', amount: addTime<%- i %>.number * 60 }));
                window.location = "/checked?id=" + addTime<%- i %>.id;
                
            } 
            
        }
        if (wait_minutes > timeToStart<%- i %> && addTime<%- i %>.checked === 0 && addTime<%- i %>.reservation === 1) {
       
       socket.send(JSON.stringify({ action: 'increase', amount: addTime<%- i %>.number * 60}))
                                    
       window.location="/checked?id=" + addTime<%- i %>.id;
     }
    <% } %>
}


    function inputWaitTime() {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚’ "YYYY-MM-DDTHH:mm" ã®å½¢å¼ã«å¤‰æ›
        wait_minutes = new Date(now.getTime() + timerValue * 1000 );
        let year = wait_minutes.getFullYear();
        let month = String(wait_minutes.getMonth() + 1).padStart(2, '0'); // æœˆã¯0å§‹ã¾ã‚Š
        let date = String(wait_minutes.getDate()).padStart(2, '0');
        let hours = String(wait_minutes.getHours()).padStart(2, '0');
        let minutes = String(wait_minutes.getMinutes()).padStart(2, '0');

        // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ãŸæ—¥æ™‚ã‚’ç”Ÿæˆ
        let localDateTime = `${year}-${month}-${date}T${hours}:${minutes}`;

        // input è¦ç´ ã«è¨­å®š
        document.getElementById('time').value = localDateTime;
      }

      

    setInterval(function() {
        wait_minutes = new Date(new Date().getTime() + timerValue * 1000); // æœ€æ–°ã«æ›´æ–°
        addTelOrder();
        
    }, 1000);
      

    let switch_bt = document.getElementById('switch_bt');
    let form = document.getElementById('form');
    let grid5 = document.getElementById('grid-5');
    switch_bt.addEventListener('click', function() {
        
        if(form.classList.contains('grid-5')) {
            form.classList.remove('grid-5');
            grid5.classList.add('grid-5')
        } else {
            form.classList.add('grid-5')
            grid5.classList.remove('grid-5');
        }
    })

    let s = 55;
  
    document.getElementById('1minute++').addEventListener('click', function(){
              socket.send(JSON.stringify({ action: 'increase', amount: 60}))
              updateTimer();
          });
  
    document.getElementById('1minute--').addEventListener('click', function(){
              socket.send(JSON.stringify({ action: 'increase', amount: -60}))
              updateTimer();
          });
        
    document.getElementById('5minute++').addEventListener('click', function(){
              socket.send(JSON.stringify({ action: 'increase', amount: 300}))
              updateTimer();
          });
        
    document.getElementById('5minute--').addEventListener('click', function(){
              socket.send(JSON.stringify({ action: 'increase', amount: -300}))
              updateTimer();
          });

    const reset_bt = document.getElementById('reset-bt');
    
    function reset() {
        const result = window.confirm('ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ');
        if(result) {
            socket.send(JSON.stringify({ action: 'reset'}))
        }
        
    }

    document.getElementById("is_reservation_checkbox").addEventListener("change", function () {
        document.getElementById("is_reservation").value = this.checked ? "1" : "0";
            });

    




    

    
</script>
</body>
</html>