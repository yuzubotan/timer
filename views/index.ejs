<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <style>
        body {
            background-color: #bcffff;
            max-width: 900px;
            
        }

        header {
            width: 96%;
        }

        .header {
            font-weight: bold;
            background-color: white;
            border-radius: 10px;
            width: 93px;
            height: 46px;
            line-height: 46px;
            display: inline-block;
            font-size: 16px;
            text-align: center;
            
        }
        #switch {
            float:right;
        }

        #wait_time {
            text-align: center;
            font-size: 96px;
        }

        .grid-container {
            display: grid;
            grid-template-rows: 1fr 1fr ;
            grid-template-columns: 1fr 1fr;
            height: 159px;
            gap: 30px;
            margin-bottom: 30px;
            
        }

        .grid-item {
            background-color: white;
            box-shadow: 0 4px 4px gray;
            border: 1px solid;
        }

        .grid-item:nth-child(1) {
            
            grid-row: 1 / 2;
        }

       input {
        display: inline-block;
        padding: 8px;
       }


       .grid-1 {
        width: 180px;
        text-align: center;
        display: inline-block;
        line-height: 159px;
        font-size: 96px;
       }

       .grid-2 {
        margin-bottom: 10px;
       }

       .grid-3 {
        margin-bottom:3px;
        display: inline-block;
        width: 100px;
       }

       .grid-5 {
        display: none;
        
       }

       .time {
        display: inline-block;
       }
      
       .grid-container-2 {
        
        display: grid;
        grid-template-rows: 1fr 1fr 1fr 1fr;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 30px;
        
       }

       .grid-bt {
        background-color: white;
        width: 93px;
        height: 90px;
        text-align: center;
        line-height: 97px;
        font-size: 64px;
        box-shadow: 0 4px 4px gray;
        border: 1px solid;
       }
     
       .text-bt {
        font-size: 35px;
       }
       
       .wait_time {
        padding: 0;
       }

       #switch_bt {
        width: 60px;
        height: 25px;
        margin: 0;
       }

       .time {
        height:40px;
        width: 100px;
        font-size: 20px;
        display: inline-block;
        background-color: white;
        margin-right: 10px;
       }
       
       .addTime {
        margin-bottom: 15px;
       }

       #reset-bt {
        border: 2px solid black;
        display: inline-block;
        line-height: 40px;
        text-align: center;
       }
    </style>
</head>
<body>
    <header>
        <span id="order" class="header" onclick="location.href='/order'">Ê≥®ÊñáÂ±•Ê≠¥</span>
        <span id="switch" class="header" onclick="location.href='/timeline'">switch</span>
    </header>
    <audio id="btn_audio">
        <source src= "/sound/pushNumber.mp3">
    </audio>

    <audio id="btn_audio2">
        <source src= "/sound/module.mp3">
    </audio>

    <div id="wait_time">0:00:00</div>
    <button type="button" id="switch_bt">ON/OFF</button>
    <div class="grid-container">
        <div class="grid-item grid-1" id="id"></div>
            <form action="/submit" method="POST" id="form">
                <label for="time" class="label-1">ÊôÇÂàª</label><br>
                <input type="datetime-local" id="time" name="time"  class="grid-item grid-2">
                <button type="button" onclick="openReservationModal()">‰∫àÁ¥ÑÊ≥®Êñá</button><br>
                <label for="number" class="label-2">Êú¨Êï∞</label><br>
                <input type="text" id="number" name="number" class="grid-item grid-3">
              
                
                <!-- „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÂèçÊò†„Åô„ÇãÈö†„Åó„Éï„Ç£„Éº„É´„Éâ -->
                <input type="hidden" name="reservation" id="is_reservation" value="0">
                <input type="submit" id="submit_bt" class="grid-item grid-4">
                
            </form>
            <div id="reservationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">

                <div style="background:white; width:300px; margin:100px auto; padding:20px; border-radius:10px;">

                    <h3>‰∫àÁ¥ÑÊ≥®ÊñáÂÖ•Âäõ</h3>

                    <form action="/submit" method="POST">
                        <input type="hidden" name="reservation" id="reservation" value="1">

                        <label>‰∫àÁ¥ÑÊôÇÂàª</label><br>
                        <input type="datetime-local" name="time" required><br><br>

                        <label>Êú¨Êï∞</label><br>
                        <input type="number" name="number" min="1" required><br><br>

                        <button type="submit">ÈÄÅ‰ø°</button>
                        <button type="button" onclick="closeReservationModal()">„Ç≠„É£„É≥„Çª„É´</button>
                    </form>

                </div>
            </div>
            

            
            <div class="grid-5" id="grid-5">
                <div class="addTime">
                    <button class="time" id="1minute--">- 1:00</button>
                    <button class="time" id="1minute++">+ 1:00</button>
                </div>
                <div class="addTime">
                    <button class="time" id="5minute--">- 5:00</button>
                    <button class="time" id="5minute++">+ 5:00</button>
                </div>
                <a href="javascript:reset()" class="time" id="reset-bt" >reset</a>
            </div>
            
        </div>
        
    <div class="grid-container-2">
        <div class="grid-bt" onclick="addNumber(10)">1</div>
        <div class="grid-bt" onclick="addNumber(20)">2</div>
        <div class="grid-bt" onclick="addNumber(30)">3</div>
        <div class="grid-bt" onclick="addNumber(40)">4</div>
        <div class="grid-bt" onclick="addNumber(50)">5</div>
        <div class="grid-bt" onclick="addNumber(60)">6</div>
        <div class="grid-bt" onclick="addNumber(70)">7</div>
        <div class="grid-bt" onclick="addNumber(80)">8</div>
        <div class="grid-bt" onclick="addNumber(90)">9</div>
        <div class="grid-bt text-bt" onclick="deleteLast();">del</div>
        <div class="grid-bt" onclick="addNumber(0)">0</div>
        <div class="grid-bt text-bt">+</div>
    </div>
    <button type="button" onclick="location.href='/customer'">
        customer
      </button>
    <!-- Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
<div id="confirmModal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  justify-content:center;
  align-items:center;
  z-index:9999;
">
  <div style="background:white; padding:20px; border-radius:8px; min-width:260px;">
    <p id="confirmText">„Åì„ÅÆÊ≥®Êñá„ÇíËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü</p>
    <button id="confirmOk">OK</button>
    <button id="confirmCancel">„Ç≠„É£„É≥„Çª„É´</button>
    <p id="countdown"></p>
  </div>
</div>

<script>

let timerValue = 0;
let now = new Date();
let tv = parseInt(timerValue, 10);
let wait_minutes = new Date(now.getTime() + tv * 1000);

let timeInput = document.getElementById('time');
let isUserEditingTime = false;




function openReservationModal() {
  document.getElementById("reservationModal").style.display = "block";
}

function closeReservationModal() {
  document.getElementById("reservationModal").style.display = "none";
}



function speak(text) {
    // ÈÄ£Á∂öÈÄÅ‰ø°ÂØæÁ≠ñ
    speechSynthesis.cancel();

    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'ja-JP';
    utter.rate = 1.0;
    utter.pitch = 1.0;

    speechSynthesis.speak(utter);
}

document.getElementById('form').addEventListener('submit', function () {
    const isReservation = document.getElementById('reservation').value === "1";
    const addSeconds = document.getElementById('number').value / 10 * 60;
    const orderNumber = document.getElementById('number').value;

    if (isReservation) {
        speak('‰∫àÁ¥ÑÊ≥®Êñá„ÇíÂèó„Åë‰ªò„Åë„Åæ„Åó„Åü');
    } else {
        const minutes = Math.floor(( timerValue + addSeconds ) / 60);
        speak(`${orderNumber}Êú¨„ÅÆÊ≥®Êñá„ÇíÂèó„Åë‰ªò„Åë„Åæ„Åó„Åü„ÄÇÂæÖ„Å°ÊôÇÈñì„ÅØÁ¥Ñ${minutes}ÂàÜ„Åß„Åô`);
    }
});


function audio() {
    
    document.getElementById('btn_audio').currentTime = 0; //ÈÄ£Á∂ö„ÇØ„É™„ÉÉ„ÇØ„Å´ÂØæÂøú
    document.getElementById('btn_audio').play(); //„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈü≥„ÇíÂÜçÁîü
}

function audio2() {
    
    document.getElementById('btn_audio2').currentTime = 0; //ÈÄ£Á∂ö„ÇØ„É™„ÉÉ„ÇØ„Å´ÂØæÂøú
    document.getElementById('btn_audio2').play(); //„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈü≥„ÇíÂÜçÁîü
}



    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const socket = new WebSocket(`${protocol}://${location.host}`);

    socket.onopen = function() {
        console.log("‚úÖ WebSocket Êé•Á∂öÊàêÂäü");
    }

    socket.onmessage = function(event) {
        const message = JSON.parse(event.data);
        console.log("üì© „Çø„Ç§„Éû„ÉºÂÄ§„ÇíÂèó‰ø°:", message.timerValue);

        if (
            message.type === 'update' &&
            document.getElementById("is_reservation").value === "0"
        ) {
            timerValue = message.timerValue;
            updateTimer();
            if (!isUserEditingTime) inputWaitTime();
        }

        

        if (message.type === 'gap') {
            if (socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify({
                action: 'increase',
                amount: message.amount
            }));
            }
        }
        };

        
            
    

    socket.onclose = function() {
    console.log("‚ùå WebSocket Êé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü");
};

    const number = document.getElementById('number');
    
  
    function addNumber(num) {
        number.value += num;
        audio();
    }

    function deleteLast() {
        number.value = number.value.slice(0, -1);
    }

    

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´Ê¨°„ÅÆID„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
    window.onload = function () {
        fetch('/next-id')
            .then(response => response.json())
            .then(data => {
                const idDiv = document.getElementById('id');
                idDiv.textContent = data.nextId; // Ê¨°„ÅÆID„ÇíË°®Á§∫
            })
            .catch(error => {
                console.error('Ê¨°„ÅÆID„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü:', error);
            });


            inputWaitTime();
           
    };

    

    function updateTimer() {
            const timerElement = document.getElementById('wait_time');
            let hours = Math.floor(timerValue / 3600);
            let minutes = Math.floor((timerValue % 3600) / 60);
            let seconds = timerValue % 60;
            
            timerElement.textContent = `${String(hours).padStart(1, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

    
    let gapSent = false;
  
    async function addTelOrder() {

  if (isModalOpen) return;

  let earliestReservationStart = null;

  <% for (let i = 0; i < data.length ; i++) { %>

    let needMinutes<%- i %> = <%= data[i].number / 10 + 5 %>;
    let addTime<%- i %> = { 
      id: <%= data[i].id %>, 
      number: <%= data[i].number / 10 %>, 
      checked: <%= data[i].checked %>, 
      reservation: <%= data[i].reservation %>, 
      absorbed: <%= data[i].absorbed ?? 0 %>,
      done: <%= data[i].done %>,
      time: new Date('<%= data[i].time %>')
    };

    let timeToStart<%- i %> =
      new Date(addTime<%- i %>.time.getTime() - needMinutes<%- i %> * 60 * 1000);

    // ‚ë† ‰∫àÁ¥Ñ„ÅÆÊúÄ„ÇÇÊó©„ÅÑÈñãÂßãÊôÇÂàª
    if (addTime<%- i %>.reservation === 1) {
      if (!earliestReservationStart || timeToStart<%- i %> < earliestReservationStart) {
        earliestReservationStart = timeToStart<%- i %>;
      }
    }

    // ‚ë° ÈÄöÂ∏∏Ê≥®Êñá
    if (
      addTime<%- i %>.checked === 0 &&
      addTime<%- i %>.reservation === 0 &&
      (!earliestReservationStart || wait_minutes < earliestReservationStart)
    ) {
      socket.send(JSON.stringify({
        action: 'increase',
        amount: addTime<%- i %>.number * 60
      }));
      window.location = "/checked?id=" + addTime<%- i %>.id;
      return; // ‚Üê 1‰ª∂Âá¶ÁêÜ„Åó„Åü„ÇâÁµÇ‰∫Ü„ÅØOK
    }

    // ‚ë¢ ‰∫àÁ¥ÑÊ≥®ÊñáÔºà„É¢„Éº„ÉÄ„É´‰ªò„ÅçÔºâ
    if (
      wait_minutes > timeToStart<%- i %> &&
      addTime<%- i %>.checked === 0 &&
      addTime<%- i %>.reservation === 1
    ) {
      const confirmed = await confirmWithTimeout(
        `‰∫àÁ¥Ñ„ÇíËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü ${addTime<%- i %>.time.getHours()}ÊôÇ${addTime<%- i %>.time.getMinutes()}ÂàÜ„Å´${addTime<%- i %>.number * 10} Êú¨„Åß„Åô`,
        15000
      );

      if (confirmed) {
        
        // ‚ùó „Åì„ÅÆÊ≥®Êñá„Å†„Åë„Çπ„Ç≠„ÉÉ„ÉóÔºàÊ¨°„Å∏Ôºâ
        let amount = addTime<%- i %>.number * 60;
        if (addTime<%- i %>.absorbed == 1) {
            amount = 0;
        }
        
        
        socket.send(JSON.stringify({ action: 'increase', amount }));
        
        window.location = "/checked?id=" + addTime<%- i %>.id;
        
        return;
        
      } else {
        
        
        console.log('cancel')
        window.location = "/timeline/del?id=" + addTime<%- i %>.id;
        return;
      }
    }

  <% } %>
}



    function inputWaitTime() {
        // „É≠„Éº„Ç´„É´„Çø„Ç§„É†„Çí "YYYY-MM-DDTHH:mm" „ÅÆÂΩ¢Âºè„Å´Â§âÊèõ
        wait_minutes = new Date(now.getTime() + timerValue * 1000 );
        let year = wait_minutes.getFullYear();
        let month = String(wait_minutes.getMonth() + 1).padStart(2, '0'); // Êúà„ÅØ0Âßã„Åæ„Çä
        let date = String(wait_minutes.getDate()).padStart(2, '0');
        let hours = String(wait_minutes.getHours()).padStart(2, '0');
        let minutes = String(wait_minutes.getMinutes()).padStart(2, '0');

        // „Éï„Ç©„Éº„Éû„ÉÉ„Éà„Åó„ÅüÊó•ÊôÇ„ÇíÁîüÊàê
        let localDateTime = `${year}-${month}-${date}T${hours}:${minutes}`;

        // input Ë¶ÅÁ¥†„Å´Ë®≠ÂÆö
        document.getElementById('time').value = localDateTime;
      }

      

    setInterval(function() {
        wait_minutes = new Date(new Date().getTime() + timerValue * 1000); // ÊúÄÊñ∞„Å´Êõ¥Êñ∞
        addTelOrder();
        
    }, 1000);

      

    let switch_bt = document.getElementById('switch_bt');
    let form = document.getElementById('form');
    let grid5 = document.getElementById('grid-5');
    switch_bt.addEventListener('click', function() {
        
        if(form.classList.contains('grid-5')) {
            form.classList.remove('grid-5');
            grid5.classList.add('grid-5')
        } else {
            form.classList.add('grid-5')
            grid5.classList.remove('grid-5');
        }
    })

    let s = 55;
  
    document.getElementById('1minute++').addEventListener('click', function(){
              socket.send(JSON.stringify({ action: 'increase', amount: 60}))
              updateTimer();
          });
  
    document.getElementById('1minute--').addEventListener('click', function(){
              socket.send(JSON.stringify({ action: 'increase', amount: -60}))
              updateTimer();
          });
        
    document.getElementById('5minute++').addEventListener('click', function(){
              socket.send(JSON.stringify({ action: 'increase', amount: 300}))
              updateTimer();
          });
        
    document.getElementById('5minute--').addEventListener('click', function(){
              socket.send(JSON.stringify({ action: 'increase', amount: -300}))
              updateTimer();
          });

    const reset_bt = document.getElementById('reset-bt');
    
    function reset() {
        const result = window.confirm('„Çø„Ç§„Éû„Éº„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü');
        if(result) {
            socket.send(JSON.stringify({ action: 'reset'}))
        }
        
    }

   
    
    setInterval(function() {
        window.location.reload()
      }, 1000 * 60 * 5)


    let isModalOpen = false;

function confirmWithTimeout(message, timeoutMs = 15000) {
  return new Promise(resolve => {
    const modal = document.getElementById("confirmModal");
    const okBtn = document.getElementById("confirmOk");
    const cancelBtn = document.getElementById("confirmCancel");
    const countdown = document.getElementById("countdown");
    const text = document.getElementById("confirmText");

    

    text.textContent = message;
    speak(message);
    modal.style.display = "flex";
    isModalOpen = true;
    audio2();
    let remaining = timeoutMs / 1000;
    countdown.textContent = `Ëá™ÂãïÁ¢∫ÂÆö„Åæ„Åß ${remaining} Áßí`;

    const interval = setInterval(() => {
      remaining--;
      countdown.textContent = `Ëá™ÂãïÁ¢∫ÂÆö„Åæ„Åß ${remaining} Áßí`;
    }, 1000);

    const timer = setTimeout(() => {
      cleanup();
      resolve(true);
    }, timeoutMs);

    function cleanup() {
      clearTimeout(timer);
      clearInterval(interval);
      modal.style.display = "none";
      isModalOpen = false;
    }

    okBtn.onclick = () => {
      cleanup();
      resolve(true);
    };

    cancelBtn.onclick = () => {
      cleanup();
      resolve(false);
    };
  });
}

    

    
</script>
</body>
</html>