<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
      button, span {
        margin: 0;
        padding: 0;
      }

      html {
        max-width: 900px;
      }
      body {
        background-color: #bcffff;
        font-family: Arial, sans-serif;
        overflow: hidden; /* スクロールバーを隠す */
      }
  
      .timeline-container {
        position: relative;
        width: 400px; /* タイムラインの幅 */
        height: 3000px;
        margin: 0 auto;
        border: 1px solid;
        display: flex;
        justify-content: left;
        background-color: #f0f0f0;
        overflow: scroll;
        
      }
  
      .timeline {
        position: absolute;
        top: 50px;
        left: 50px;
        width: 2px; /* 直線の幅 */
        background-color: #333; /* 直線の色 */
        height: 30000px; /* タイムラインの高さを設定 */
        
      }
  
      .time-marker {
        position: absolute;
        left: -40px; /* 直線からの距離 */
        font-size: 14px;
        color: #333;
        transform: translateY(-50%);
      }
        
      header {
        width: 96%;
        height: 60px;
        position: sticky;
        z-index: 10;
      }
        
      .header {
          font-weight: bold;
          background-color: white;
          border-radius: 10px;
          width: 93px;
          height: 46px;
          line-height: 46px;
          display: inline-block;
          font-size: 16px;
          text-align: center;
      }

      #switch {
          float:right;
      }

      .data-item {
      position: absolute;
      display: flex;
      justify-content: center;
      width: 300px;
      left: 55px;
      font-size: 15px;
      color: #333;
      transform: translateY(-50%);
    
    }

      .point {
        color: red;
        position: absolute;
        left: -15px;
        top: 5px;
        font-size: 30px

      }
    
      .id {
        border: 1px solid;
        background-color: white;
        display: inline-block;
        width: 40px;
        height: 50px;
        font-size: 30px;
        font-weight: bold;
        line-height: 50px;
        text-align: center;
        margin-right: 5px;
      }

      .bt {
        border: 1px solid;
        background-color: white;
        width: 50px;
        height: 50px;
        display: inline-block;
        margin-right: 5px;
      }

      .order {
        border: 1px solid;
        background-color: white;
        height: 50px;
        line-height: 50px;
        display: inline-block;
        margin-right: 5px;
      }

        
    </style>
</head>
<body>
    <header>
        <span id="order" class="header" onclick="location.href='/order'">注文履歴</span>
        <span id="switch" class="header" onclick="location.href='/'">switch</span>
    </header>
    <div id="wait_time">0:00:00</div>
    <div class="timeline-container">
        <div class="timeline">
          
      
          
        </div>
        <div class="timeline2">
          <% for (const item of data) { %>
            <% 
              const currentTime = new Date();
              let itemTop = 250 + ((Math.floor(item.hour * 12) + Math.floor(item.minutes / 5)) * 200 + (item.minutes % 5) * 40) - ((currentTime.getHours() * 12 + Math.floor(currentTime.getMinutes() / 5)) * 200  + (currentTime.getMinutes() % 5 * 40));
            %>
            
            <% if(itemTop >= 0) { %>
              <div class="data-item" style="top: <%= itemTop %>px">
                <span class="point">●</span><span class="id"><%= item.id %></span>
                <button class="bt" onclick="javascript:del(<%= item.id %>, <%= item.number %>)">DEL</button>
                <span class="order" style="<%= item.reservation === 1 ? 'background-color: lightblue;' : '' %>">
                  開始:<%= item.startTime %> 本数:<%= item.number %>
                  <% if(item.reservation === 1) { %>
                    <br>予約:<%= item.reserveTime %>
                  <% } %>
                </span>
                <button class="bt" id="ok" onclick="javascript:modify(<%= item.id %>,<%= item.number %>)">OK</button>
              </div>
            <% } %>
          <% } %>
        </div>
        
        
    </div>
    <script>
      const socket = new WebSocket('ws://localhost:3001');

      socket.onmessage = function(event) {
        const message = JSON.parse(event.data)
        if(message.type === "update") {
          let timerValue = message.timerValue;
          let hours = Math.floor(timerValue / 3600);
          let minutes = Math.floor((timerValue % 3600) / 60);
          let seconds = timerValue % 60;

          document.getElementById('wait_time').textContent = `${String(hours).padStart(1, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        if(message.type === 'del') {
          socket.send(JSON.stringify({ action: 'increase', amount: message.amount }));
        }
      }
            // タイムラインコンテナ
const timeline = document.querySelector('.timeline');
const timeline2 = document.querySelector('.timeline2');
const currentTime = new Date();



// 初期時間と表示のステップ（5分刻み）
let startTime = new Date(new Date().getTime() - 5 * 60 * 1000);

const stepMinutes = 5; // 5分刻み
const duration =  13 ; // 営業時間(１１時間分)のタイムライン
const totalSteps = duration / (stepMinutes / 60);

// タイムラインに時間マーカーを追加する
for (let i = 0; i <= totalSteps; i++) {
  const marker = document.createElement('div');
  marker.classList.add('time-marker');

  // 時間のフォーマット（hh:mm形式）
  const time = new Date(startTime.getTime() + i * stepMinutes * 60 * 1000);
  const formattedTime = time.getHours().toString().padStart(2, '0') + ':' + time.getMinutes().toString().padStart(2, '0');

  marker.textContent = formattedTime;
  marker.style.top = `${i * 200}px`; // 各マーカーの位置を調整（200pxごとに表示）
  
  timeline.appendChild(marker);
}


// 縦スクロールを時間経過とリンク
let scrollPosition = 0;
const scrollSpeed = 0.025; // スクロールの速さ（px単位）

function scrollTimeline() {
  scrollPosition += scrollSpeed;
  timeline.style.transform = `translateY(-${scrollPosition}px)`;
  timeline2.style.transform = `translateY(-${scrollPosition}px)`;
  
  requestAnimationFrame(scrollTimeline);
}

// スクロールを開始
scrollTimeline();

let timeToAdjust = 0;

function del(id, number) {
          timeToAdjust = number / 10 * 60;
          console.log(timeToAdjust);
        
          let result = window.confirm('id=' + id + 'を削除しますか？');
          if (result) {
            window.location = "/timeline/del?id=" + id;
          }
        }

function modify(id, number) {
  
  let result = window.confirm('id=' + id + 'が出来上がりましたか？');
  if(result) {
    
    window.location = "/timeline/modify?id=" + id;
  }
  document.getElementById('ok').style.opacity = 0.2;
}

    </script>
</body>
</html>