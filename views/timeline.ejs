<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
      button, span {
        margin: 0;
        padding: 0;
      }

      html {
        max-width: 900px;
      }
      body {
        background-color: #bcffff;
        font-family: Arial, sans-serif;
        overflow: hidden; /* スクロールバーを隠す */
      }
  
      .timeline-container {
        position: relative;
        width: 400px; /* タイムラインの幅 */
        height: 3000px;
        margin: 0 auto;
        border: 1px solid;
        display: flex;
        justify-content: left;
        background-color: #f0f0f0;
        overflow: scroll;
        
      }
  
      .timeline {
        position: absolute;
        top: 50px;
        left: 50px;
        width: 2px; /* 直線の幅 */
        background-color: #333; /* 直線の色 */
        height: 30000px; /* タイムラインの高さを設定 */
        
      }
  
      .time-marker {
        position: absolute;
        left: -40px; /* 直線からの距離 */
        font-size: 14px;
        color: #333;
        transform: translateY(-50%);
      }
        
      header {
        width: 96%;
        height: 60px;
        position: sticky;
        z-index: 10;
      }
        
      .header {
          font-weight: bold;
          background-color: white;
          border-radius: 10px;
          width: 93px;
          height: 46px;
          line-height: 46px;
          display: inline-block;
          font-size: 16px;
          text-align: center;
      }

      #switch {
          float:right;
      }

      .data-item {
      position: absolute;
      display: flex;
      justify-content: center;
      width: 300px;
      left: 55px;
      font-size: 15px;
      color: #333;
      transform: translateY(-50%);
    
    }

      .point {
        color: red;
        position: absolute;
        left: -15px;
        top: 5px;
        font-size: 30px

      }
    
      .id {
        border: 1px solid;
        background-color: white;
        display: inline-block;
        width: 40px;
        height: 50px;
        font-size: 30px;
        font-weight: bold;
        line-height: 50px;
        text-align: center;
        margin-right: 5px;
      }

      .bt {
        border: 1px solid;
        background-color: white;
        width: 50px;
        height: 50px;
        display: inline-block;
        margin-right: 5px;
      }

      .order {
        border: 1px solid;
        background-color: white;
        height: 50px;
        line-height: 50px;
        display: inline-block;
        margin-right: 5px;
      }


      .data-item {
        transition: opacity 0.2s;
      }

      .data-item.processing {
        opacity: 0.5;
      }

      .data-item.done {
        opacity: 0.3;
      }

      .data-item.processing .ok,
      .data-item.done .ok {
        pointer-events: none;
        opacity: 0.5;
      }

        
    </style>
</head>
<body>
    <header>
        <span id="order" class="header" onclick="location.href='/order'">注文履歴</span>
        <span id="switch" class="header" onclick="location.href='/'">switch</span>
    </header>
    <span id="wait_time">0:00:00</span>
    <button id="reload">最新の情報に更新</button>
    <div class="timeline-container">
        <div class="timeline" style="top:300px">
          
      
        </div>
        <div class="timeline2">
          <% for (const item of data) { %>
            <% 
              const currentTime = new Date();
              let itemTop = 500 + ((Math.floor(item.hour * 12) + Math.floor(item.minutes / 5)) * 200 + (item.minutes % 5) * 40) - ((currentTime.getHours() * 12 + Math.floor(currentTime.getMinutes() / 5)) * 200  + (currentTime.getMinutes() % 5 * 40));
            %>
            
            <% if(itemTop >= 0) { %>
              <div class="data-item <%= item.done == 1 ? 'done' : '' %>" style="top: <%= itemTop %>px">
                <span class="point">●</span><span class="id"><%= item.id %></span>
                <button class="bt" onclick="javascript:del(<%= item.id %>, <%= item.number %>)">DEL</button>
                <span class="order" style="<%= item.reservation === 1 ? 'background-color: lightblue;' : '' %>">
                  開始:<%= item.startTime %> 本数:<%= item.number %>
                  <% if(item.reservation === 1) { %>
                    <br>予約:<%= item.reserveTime %>
                    <% if (item.merged_from) { %>
                      <div class="merged-info">
                        （ID: <%= item.merged_from %>）
                      </div>
                    <% } %>

                  <% } %>
                </span>
                <button class="bt ok"
                  <%= item.done == 1 ? 'disabled' : '' %>
                  <%- item.done == 1 ? '' : 'onclick="modify(this, ' + item.id + ', ' + item.number + ')"' %>>OK</button>


              </div>
            <% } %>
          <% } %>
        </div>
        
        
    </div>
    <script>
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      const socket = new WebSocket(`${protocol}://${location.host}`);

      socket.onmessage = function(event) {

    console.log("WS received:", event.data);

    document.getElementById('reload').addEventListener('click', ()=>{
      window.location.reload();
    })

    // JSON に変換
    const message = JSON.parse(event.data);

    if(message.type === "update") { 
      timerValue = message.timerValue; 
      let hours = Math.floor(timerValue / 3600); 
      let minutes = Math.floor((timerValue % 3600) / 60); 
      let seconds = timerValue % 60; 
      document.getElementById('wait_time').textContent = 
      `${String(hours).padStart(1, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; }

    // --- デバッグログ ---
    console.log("action:", message.action);
    console.log("message.action === 'modify' ?", message.action === 'modify');
    console.log("message.action === 'del' ?", message.action === 'del');

    // --- modify の処理 ---
    console.log(message.action)
    if (message.type === 'modify') {
        console.log('modify 受信 → 加算実行', timerValue);
        
        timerValue += message.amount;

        socket.send(
            JSON.stringify({
                action: 'increase',
                amount: message.amount
            })
        );
    }


    // --- del の処理 ---
    if (message.action === 'del') {
        console.log('del 受信 → 加算実行', timerValue);

        socket.send(
            JSON.stringify({
                action: 'increase',
                amount: message.amount
            })
        );
    }
};


async function modify(button, id, number) {

  console.log('modify called, id=', id); // ← 必ず出る
  if (button.dataset.locked === '1') {
    return;
  }
  button.dataset.locked = '1';

  if (!window.confirm('id=' + id + 'が出来上がりましたか？')) {
    button.dataset.locked = '';

    return;
  }

  // 二度押し防止
  button.disabled = true;

  const dataItem = button.closest('.data-item');
  dataItem.classList.add('processing');

  try {
    const response = await fetch(`/timeline/modify?id=${id}`, {
      method: 'GET'
    });

    if (!response.ok) throw new Error('server error');

    // 成功
    dataItem.classList.remove('processing');
    dataItem.classList.add('done');

    setTimeout(() => {
      window.location.reload();
    }, 200);

  } catch (e) {
    // 失敗時は元に戻す
    alert('通信に失敗しました');
    dataItem.classList.remove('processing');
    button.disabled = false;
    button.dataset.locked = '';
  }
}


            // タイムラインコンテナ
const timeline = document.querySelector('.timeline');
const timeline2 = document.querySelector('.timeline2');
const currentTime = new Date();



// 初期時間と表示のステップ（5分刻み）
let startTime = new Date(new Date().getTime() - 5 * 60 * 1000);

const stepMinutes = 5; // 5分刻み
const duration =  13 ; // 営業時間(１１時間分)のタイムライン
const totalSteps = duration / (stepMinutes / 60);

// タイムラインに時間マーカーを追加する
for (let i = 0; i <= totalSteps; i++) {
  const marker = document.createElement('div');
  marker.classList.add('time-marker');

  // 時間のフォーマット（hh:mm形式）
  const time = new Date(startTime.getTime() + i * stepMinutes * 60 * 1000);
  const formattedTime = time.getHours().toString().padStart(2, '0') + ':' + time.getMinutes().toString().padStart(2, '0');

  marker.textContent = formattedTime;
  marker.style.top = `${i * 200}px`; // 各マーカーの位置を調整（200pxごとに表示）
  
  timeline.appendChild(marker);
}


// 縦スクロールを時間経過とリンク
let scrollPosition = 0;
const scrollSpeed = 0.01; // スクロールの速さ（px単位）

function scrollTimeline() {
  scrollPosition += scrollSpeed;
  timeline.style.transform = `translateY(-${scrollPosition}px)`;
  timeline2.style.transform = `translateY(-${scrollPosition}px)`;
  
  requestAnimationFrame(scrollTimeline);
}

// スクロールを開始
scrollTimeline();

let timeToAdjust = 0;

function del(id, number) {
          timeToAdjust = number / 10 * 60;
          console.log(timeToAdjust);
        
          let result = window.confirm('id=' + id + 'を削除しますか？');
          if (result) {
            window.location = "/timeline/del?id=" + id;
          }
        }


    </script>
</body>
</html>